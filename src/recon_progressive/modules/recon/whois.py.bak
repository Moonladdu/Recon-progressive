"""
recon-progressive module for WHOIS lookup.
Profiles are loaded from whois.yaml if available.
"""

import subprocess
import re
import yaml
from pathlib import Path
from recon_progressive.core.base import BaseModule

class WhoisModule(BaseModule):
    """WHOIS lookup module."""

    def __init__(self):
        super().__init__()
        self.name = "whois"
        self.description = "Domain WHOIS lookup (registrar, dates, nameservers)"

        # Load profiles from YAML
        yaml_path = Path(__file__).parent / f"{self.name}.yaml"
        if yaml_path.exists():
            with open(yaml_path, 'r') as f:
                data = yaml.safe_load(f)
                self.profiles = data.get('profiles', {})
        else:
            # Fallback hardcoded profiles
            self.profiles = {
                "basic": {
                    "args": [],
                    "desc": "Standard WHOIS lookup",
                    "recommendation": "Default"
                },
                "verbose": {
                    "args": [],
                    "desc": "Verbose WHOIS output",
                    "recommendation": "Full details"
                }
            }

    def run(self, target, profile):
        cmd = ["whois", target]
        return self._run_command(cmd)

    def parse_output(self, stdout):
        lines = stdout.splitlines()
        parsed = {"raw": stdout}
        patterns = {
            "registrar": r"Registrar:\s*(.+)",
            "creation_date": r"Creation Date:\s*(.+)",
            "expiry_date": r"Registry Expiry Date:\s*(.+)",
            "name_servers": r"Name Server:\s*(.+)"
        }
        for key, pattern in patterns.items():
            matches = re.findall(pattern, stdout, re.IGNORECASE)
            if matches:
                if key == "name_servers":
                    parsed[key] = matches
                else:
                    parsed[key] = matches[0] if matches else None
        return parsed